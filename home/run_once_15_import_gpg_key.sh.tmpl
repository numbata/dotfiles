#!/bin/bash

set -euo pipefail

echo "Importing GPG keys..."

# Ensure gpg has a usable TTY (important when running via piped installers)
if [[ -r /dev/tty ]]; then
  export GPG_TTY
  GPG_TTY="$(tty < /dev/tty)"
  gpgconf --launch gpg-agent >/dev/null 2>&1 || true
  gpg-connect-agent updatestartuptty /bye >/dev/null 2>&1 || true
fi

# Import GPG keys if they exist
if [[ -f ~/.gpg/private.asc ]]; then
  if gpg --import ~/.gpg/private.asc; then
    echo "Private key imported."
  else
    echo "Failed to import private key (likely no TTY or passphrase prompt). Run: gpg --import ~/.gpg/private.asc"
  fi
else
  echo "No private key found at ~/.gpg/private.asc, skipping."
fi

if [[ -f ~/.gpg/public.asc ]]; then
  if gpg --import ~/.gpg/public.asc; then
    echo "Public key imported."
  else
    echo "Failed to import public key. Run: gpg --import ~/.gpg/public.asc"
  fi
else
  echo "No public key found at ~/.gpg/public.asc, skipping."
fi

# Set trust level for GPG key
KEY_ID=$(gpg --list-keys --with-colons 2>/dev/null | grep pub | cut -d: -f5 | head -1)
if [[ -n "$KEY_ID" ]]; then
  echo "Setting ultimate trust for key $KEY_ID..."
  echo -e "5\ny\n" | gpg --command-fd 0 --expert --edit-key "$KEY_ID" trust
  echo "GPG key trust level set."
else
  echo "No GPG key found to set trust level."
fi
